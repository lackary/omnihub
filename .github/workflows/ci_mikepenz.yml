name: Continuous Integration (main)

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md' # ignore all of .md files
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md' # ignore all of .md files

  workflow_dispatch:
    inputs:
      run_with_stacktrace:
        description: 'Run Gradle with --stacktrace'
        type: boolean
        required: false
        default: false
      run_with_info:
        description: 'Run Gradle with --info'
        type: boolean
        required: false
        default: false
      run_with_debug:
        description: 'Run Gradle with --debug'
        type: boolean
        required: false
        default: false

jobs:
  build-and-test:
    runs-on: macos-latest

    # Permissions required for Mike Penz action to publish reports
    permissions:
      checks: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Setup Environment and Run Initialization Scripts
      - name: Setup iOS Environment (Dummy Framework & Pods)
        run: |
          if [ -n "$ACT" ]; then
            echo "Running in 'act' environment."
            if ! command -v pod &> /dev/null; then
              echo "CocoaPods not found. Installing via Homebrew..."
              brew install cocoapods
            else
              echo "CocoaPods is already installed."
            fi
          else
            echo "Running in CI environment. Installing CocoaPods..."
            gem install cocoapods
          fi

          echo "Running Setup Script..."
          chmod +x setup_ios.sh
          ./setup_ios.sh


      # List simulators
      - name: List available simulators
        run: |
          echo "=== RUNTIMES ==="
          xcrun simctl list runtimes
          echo "=== DEVICES ==="
          xcrun simctl list devices

      # Automatically find an available simulator (prioritize iPhone / Booted / Available)
      - name: Select an available simulator
        id: find-sim
        run: |
          set -e

          SIM=$(xcrun simctl list devices | \
            grep -E "iPhone" | \
            grep -v unavailable | \
            grep -v "(Booted)" | \
            sed -nE 's/.*\(([0-9A-F-]{36})\).*/\1/p' | \
            head -n 1)

          if [ -z "$SIM" ]; then
            echo "❌ No available iPhone simulators found"
            exit 1
          fi

          echo "✅ Selected Simulator: $SIM"
          NAME=$(xcrun simctl list devices | grep "$SIM" | head -n 1)
          echo "✅ Selected Simulator: $NAME ($SIM)"
          echo "SIM_UUID=$SIM" >> $GITHUB_ENV

      # Execute Xcode Build
      - name: Xcode Build (clean build .xcworkspace)
        working-directory: './iosApp'
        run: |
          echo "Building iOS target via .xcworkspace..."
          xcodebuild clean build \
              -workspace "iosApp.xcworkspace" \
              -scheme "iosApp" \
              -configuration "Debug" \
              -sdk iphonesimulator \
              -destination "id=${{ env.SIM_UUID }}" \
              ENABLE_PREVIEWS=NO \
              CODE_SIGNING_ALLOWED=NO 

      # Compile
      - name: Assemble (Compile)
        run: |
          ./gradlew assemble \
          ${{ inputs.run_with_stacktrace && '--stacktrace' || '' }} \
          ${{ inputs.run_with_info && '--info' || '' }} \
          ${{ inputs.run_with_debug && '--debug' || '' }}

      # Run Checks and Tests
      - name: Check (Test & Lint)
        continue-on-error: false
        run: |
          ./gradlew check \
          ${{ inputs.run_with_stacktrace && '--stacktrace' || '' }} \
          ${{ inputs.run_with_info && '--info' || '' }} \
          ${{ inputs.run_with_debug && '--debug' || '' }}

      # Publish JUnit Test Report (GitHub Summary + PR Annotations)
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always() # Run even if tests fail
        with:
          report_paths: '**/build/test-results/**/*.xml' # Supports multi-module paths
          check_name: 'JUnit Test Report'
          detailed_summary: true # Show detailed table
          include_passed: true   # Include passed tests (similar visual effect to Dorny)
          annotate_only: ${{ env.ACT == 'true' }} # Enable "annotate only" mode when running locally via Act to skip Checks API calls

      # Upload HTML Report (For manual download and inspection)
      - name: Upload Test Report HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-html
          path: |
            **/build/reports/tests/
            **/build/reports/lint-results-*.html
          retention-days: 5
