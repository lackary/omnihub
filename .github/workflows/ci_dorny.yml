name: Continuous Integration (Dorny)

on:
#  push:
#    branches: [ "main" ]
#  pull_request:
#    branches: [ "main" ]

  workflow_dispatch:
    inputs:
      run_with_stacktrace:
        description: 'Run Gradle with --stacktrace'
        type: boolean
        required: false
        default: false
      run_with_info:
        description: 'Run Gradle with --info'
        type: boolean
        required: false
        default: false
      run_with_debug:
        description: 'Run Gradle with --debug'
        type: boolean
        required: false
        default: false

jobs:
  # Job 1: Compile and test on macOS
  build-and-test:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Setup Environment and Run Initialization Scripts
      - name: Setup iOS Environment (Dummy Framework & Pods)
        run: |
          if [ -n "$ACT" ]; then
            echo "Running in 'act' environment."
            if ! command -v pod &> /dev/null; then
              echo "CocoaPods not found. Installing via Homebrew..."
              brew install cocoapods
            else
              echo "CocoaPods is already installed."
            fi
          else
            echo "Running in CI environment. Installing CocoaPods..."
            gem install cocoapods
          fi

          echo "Running Setup Script..."
          chmod +x setup_ios.sh
          ./setup_ios.sh


      # List simulators
      - name: List available simulators
        run: |
          echo "=== RUNTIMES ==="
          xcrun simctl list runtimes
          echo "=== DEVICES ==="
          xcrun simctl list devices

      # Automatically find an available simulator (prioritize iPhone / Booted / Available)
      - name: Select an available simulator
        id: find-sim
        run: |
          set -e

          SIM=$(xcrun simctl list devices | \
            grep -E "iPhone" | \
            grep -v unavailable | \
            grep -v "(Booted)" | \
            sed -nE 's/.*\(([0-9A-F-]{36})\).*/\1/p' | \
            head -n 1)

          if [ -z "$SIM" ]; then
            echo "❌ No available iPhone simulators found"
            exit 1
          fi

          echo "✅ Selected Simulator: $SIM"
          NAME=$(xcrun simctl list devices | grep "$SIM" | head -n 1)
          echo "✅ Selected Simulator: $NAME ($SIM)"
          echo "SIM_UUID=$SIM" >> $GITHUB_ENV

      # Execute Xcode Build
      - name: Xcode Build (clean build .xcworkspace)
        working-directory: './iosApp'
        run: |
          echo "Building iOS target via .xcworkspace..."
          xcodebuild clean build \
              -workspace "iosApp.xcworkspace" \
              -scheme "iosApp" \
              -configuration "Debug" \
              -sdk iphonesimulator \
              -destination "id=${{ env.SIM_UUID }}" \
              ENABLE_PREVIEWS=NO \
              CODE_SIGNING_ALLOWED=NO 

      - name: Assemble (Compile)
        run: |
          ./gradlew assemble \
          ${{ inputs.run_with_stacktrace && '--stacktrace' || '' }} \
          ${{ inputs.run_with_info && '--info' || '' }} \
          ${{ inputs.run_with_debug && '--debug' || '' }}

      - name: Check (Test & Lint)
        continue-on-error: false
        run: |
          ./gradlew check \
          ${{ inputs.run_with_stacktrace && '--stacktrace' || '' }} \
          ${{ inputs.run_with_info && '--info' || '' }} \
          ${{ inputs.run_with_debug && '--debug' || '' }}

      # Critical step: Upload test results XML for use by the next Job
      - name: Upload Test Results XML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-xml
          path: '**/build/test-results/**/*.xml'
          retention-days: 1

      - name: Upload Test Report HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-html
          path: |
            **/build/reports/tests/
            **/build/reports/lint-results-*.html
          retention-days: 5

  # Job 2: Generate Dorny report on Linux
  report-test-results:
    name: Report Test Results
    runs-on: ubuntu-latest # Dorny must run in a Linux (Docker) environment
    needs: build-and-test
    permissions:
      checks: write      # Required permission
      pull-requests: write
      contents: read
    if: always()
    steps:
      - name: Install Git (for act environment)
        if: ${{ env.ACT }}
        run: |
          apt-get update && apt-get install -y git

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-xml
          path: test-results

      - name: Dorny Test Reporter
        uses: dorny/test-reporter@v1
        if: (success() || failure()) && !env.ACT
        with:
          name: JUnit Test Report # Name displayed in the left menu
          path: 'test-results/**/*.xml'
          reporter: java-junit
          fail-on-error: false
          token: ${{ secrets.GITHUB_TOKEN }}
